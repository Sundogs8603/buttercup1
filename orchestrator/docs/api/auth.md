# CRS Task Server Authentication

The CRS Task Server uses HTTP Basic Authentication with Argon2id-hashed tokens for secure access control.

## Authentication System

The authentication system uses:

- **Key ID**: A UUID that identifies the API key (used as username in HTTP Basic Auth)
- **Token**: A secure random string (used as password in HTTP Basic Auth)
- **Argon2id**: A modern, secure hashing algorithm for password storage

Tokens are stored as Argon2id hashes, which provides strong protection against various attacks, including:
- Brute force attacks
- Rainbow table attacks
- Side-channel attacks 

## Generating API Keys

To generate a new API key and token, use the provided CLI tool:

```bash
# Generate a new API key and display the information
buttercup-auth-tool

# Generate a new API key and format as environment variables
buttercup-auth-tool --env

# Generate a new API key with a custom token length
buttercup-auth-tool --token-length 64
```

## Configuring API Keys

Configure the Task Server by setting the following environment variables:

### Environment Variables

Configure the authentication using the following environment variables:

- `BUTTERCUP_TASK_SERVER_API_KEY_ID`: The UUID key identifier for authentication
- `BUTTERCUP_TASK_SERVER_API_TOKEN_HASH`: The Argon2id hash of the authentication token

Example:
```bash
export BUTTERCUP_TASK_SERVER_API_KEY_ID="123e4567-e89b-12d3-a456-426614174000"
export BUTTERCUP_TASK_SERVER_API_TOKEN_HASH="$argon2id$v=19$m=65536,t=3,p=4$..."
```

### Using the Auth Tool

The `buttercup-auth-tool` can be used to generate these values in the correct format:

```bash
# Generate values and display them
buttercup-auth-tool --env
```

The tool will output:
1. Server-side environment variables (with the `BUTTERCUP_TASK_SERVER_` prefix)
2. Client-side authentication credentials (API_KEY_ID and API_TOKEN) for use in API requests

You can export the server-side environment variables directly:
```bash
# Export server environment variables directly
$(buttercup-auth-tool --env | grep BUTTERCUP | sed 's/^/export /')
```

## Making Authenticated Requests

When making requests to the Task Server, clients must provide authentication credentials using HTTP Basic Auth:

1. **Username**: The UUID API key ID (generated by the auth tool)
2. **Password**: The plaintext token (generated by the auth tool)

Example with curl:
```bash
curl -X POST "http://localhost:8000/v1/task/" \
  -H "Content-Type: application/json" \
  -u "550e8400-e29b-41d4-a716-446655440000:abcDEF123456XYZghi789jklMNOP" \
  -d '{"name":"example"}'
```

Example in Python:
```python
import requests

# API key ID and token generated by buttercup-auth-tool
api_key_id = "550e8400-e29b-41d4-a716-446655440000"
api_token = "abcDEF123456XYZghi789jklMNOP"

response = requests.post(
    "http://localhost:8000/v1/task/",
    auth=(api_key_id, api_token),
    json={"name": "example"}
)
```

**Important**: The client only needs the key ID and plaintext token - NOT the Argon2id hash. The hash is only used server-side to verify the token.

## Security Considerations

- Store API tokens securely and never commit them to version control
- Use HTTPS in production environments to protect tokens in transit
- Rotate tokens periodically for improved security
- Consider using environment-specific tokens for different deployment environments